---
output: 
  word_document:
    reference_docx: ..\..\PFA_report_template_v1.4.dotx
---

```{r setup, include=FALSE}

################################################################################
# EqSim Summarize.Rmd
#
# 06/07/2020 tested on 1000 iters of SAM assessment
# 05/08/2020 converted to Rmd file
#
################################################################################

require("knitr")
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, crop = TRUE, comment = "")
knitr::opts_chunk$set(fig.width=10) 

options(dplyr.summarise.inform = FALSE)

# rm(list=ls())
invisible(gc())

library(tidyverse)

#computer specific locations
stats.dir <- file.path(Res.dir, "Stats")

# ==================================================================================

#basic display setting
# niters <- 1000
nworm  <- 5
maxyr <- yEnd

FLSs@stock  <- ssb(FLSs)

dfhistfbar <- as.data.frame(fbar(FLSs)) %>% mutate(slot="fbar")
dfhistrec  <- as.data.frame(rec(FLSs)) %>% mutate(slot="rec", age=as.character(age))
dfhistpblim <- 
  as.data.frame(ssb(FLSs)) %>% 
  mutate(perfstat = "pblim") %>% 
  mutate(period = "HI") %>% 
  dplyr::select(perfstat, age, year, period, value=data) %>%
  group_by(perfstat, age, year, period ) %>%
  summarize(mean   = sum((value< OM[["refPts"]][["Blim"]])) / niters) 
  
dfhist <- 
  as.data.frame(FLSs) %>% 
  bind_rows(dfhistfbar) %>% 
  bind_rows(dfhistrec) %>% 
  mutate(period = "HI") %>% 
  dplyr::select(perfstat=slot, age, year, period, value=data) %>%
  
  # filter(perfstat=="stock") %>% View()

  group_by(perfstat, age, year, period ) %>%
  summarize(mean   = mean(value, na.rm=TRUE),
            median = median(value, na.rm=TRUE),
            upper  = quantile(value, probs=0.975, na.rm=TRUE),
            lower  = quantile(value, probs=0.025, na.rm=TRUE)) %>%
  
  bind_rows(dfhistpblim) %>% 
  
  mutate(method = "EqSim") %>%
  mutate(niters = as.numeric(niters)) %>%
  mutate(nyrs   = as.numeric(nyrs)) %>%
  mutate(blim = OM[["refPts"]][["Blim"]]) %>%
  mutate(bpa = OM[["refPts"]][["Bpa"]]) %>% 
  ungroup()

wormhist <- 
  as.data.frame(FLSs) %>% 
  bind_rows(dfhistfbar) %>% 
  bind_rows(dfhistrec) %>% 
  # mutate(iter = as.numeric(iter)) %>% 
  filter(as.numeric(iter) <= nworm) %>% 
  mutate(period = "HI") %>% 
  dplyr::select(perfstat=slot, age, year, period, iter, value=data)  %>%
  mutate(method = "EqSim") %>%
  mutate(niters = as.numeric(niters)) %>%
  mutate(nyrs   = as.numeric(nyrs)) %>%
  mutate(blim = OM[["refPts"]][["Blim"]]) %>%
  mutate(bpa = OM[["refPts"]][["Bpa"]]) %>% 
  ungroup()


# Read the results files
filelist <- list.files(path=stats.dir, pattern="^WHOM", full.names=TRUE)
 
df <- worms <- data.frame(stringsAsFactors = FALSE)

# x <-
#       loadRData(filelist[1])[["df"]] %>%
#       lowcase()

# i <- 1
for (i in 1:length(filelist)) {

  invisible(gc())
  cat(filelist[i],"\n")

  if(grepl("^sam", basename(filelist[i]))) {

    # sam hcr files
    x <-
      loadRData(filelist[i]) %>%
      lowcase() %>%
      mutate(perfstat = tolower(perfstat)) %>%
      mutate(perfstat = ifelse(perfstat == "fbar", "harvest", perfstat)) %>%
      mutate(label = as.character(NA))

  } else {

    # eqsim files
    # OM <- loadRData(filelist[i])[["OM"]]
    # MP <- loadRData(filelist[i])[["MP"]]
    x <-
      loadRData(filelist[i])[["df"]] %>%
      lowcase() %>%
      mutate(perfstat = tolower(perfstat)) %>%
      mutate(method = "EqSim") %>%
      mutate(iter   = as.numeric(iter)) %>%
      mutate(niters = as.numeric(niters)) %>%
      mutate(nyrs   = as.numeric(nyrs)) %>%
      mutate(blim = OM[["refPts"]][["Blim"]]) %>%
      mutate(bpa = OM[["refPts"]][["Bpa"]])

  }


    # summarize the dataframe for this run
  summ <-
    x %>%
    group_by(runref, assess, method, om, mp, niters, nyrs, label, ftgt, perfstat, unit, blim, bpa,
             period, year) %>%
    mutate(value = ifelse(perfstat=="iav" & ftgt==0, NA, value)) %>%
    summarize(mean = mean(value, na.rm=TRUE),
              median = median(value, na.rm=TRUE),
              upper = quantile(value, probs=0.975, na.rm=TRUE),
              lower = quantile(value, probs=0.025, na.rm=TRUE)) %>%
    ungroup()

  df    <- bind_rows(df, summ)

  # add the worms of this run
  y <-
    x %>%
    group_by(runref, assess, method, om, mp, niters, nyrs, label, ftgt, perfstat, unit, blim, bpa,
             period, year) %>%
    filter(row_number() <= nworm) %>%
    ungroup()

  worms <- bind_rows(worms, y)

}

save(dfhist,file = file.path(temp.dir,paste0("dfhist.Rdata")))
save(wormhist,file = file.path(temp.dir,paste0("wormhist.Rdata")))

# df <- 
#   df %>% 
#   mutate(
#     mean = ifelse(perfstat == "catch", 1000*mean, mean),
#     median = ifelse(perfstat == "catch", 1000*median, median),
#     upper = ifelse(perfstat == "catch", 1000*upper, upper),
#     lower = ifelse(perfstat == "catch", 1000*lower, lower))
# worms <- worms %>% mutate(value = ifelse(perfstat == "catch", 1000*value, value))

save(df,file = file.path(temp.dir,paste0("df.Rdata")))
save(worms,file = file.path(temp.dir,paste0("worms.Rdata")))

# load(file = file.path(temp.dir,paste0("df.Rdata")))
# load(file = file.path(temp.dir,paste0("worms.Rdata")))

# unique(df$perfstat)

periods <-
  bind_rows(df, dfhist) %>% 
  distinct(period,year) 

periods2 <-
  periods %>% 
  group_by(period) %>% 
  summarize(
    yearrange = paste(min(year),max(year), sep="-"),
        year = max(year) )



# plot function
plotvar <- function(myruns =  c("WHOM_SS3_OM2.2_MP5.03_1000_23", 
                                "WHOM_SS3_OM2.2_MP5.13_1000_23",
                                "WHOM_SS3_OM2.2_MP5.23_1000_23"),
                    myftgt = c(0.0, 0.025, 0.05, 0.075, 0.10, 0.125, 0.15),
                    myperfstat = "ssb",
                    mycolour   = "blue",
                    myyintercept = 834000,
                    myvalue="median",
                    myrow = "mp") {
  
  d <- 
    df %>%
    filter(ftgt %in% myftgt) %>% 
    filter(perfstat==myperfstat) %>% 
    filter(runref %in% myruns) %>% 
    # separate(runref, into=c("stock","assess","om","mp","iters","nyears"), sep="_", convert=FALSE) %>% 
    mutate(code = paste(method, assess,sep="_")) 
  
  mp <- d %>% distinct(mp) %>% summarize(s = paste(mp, collapse="_")) %>% as.character()
  
  p <-
    d %>% 
    ggplot(aes(x=year, y=get(myvalue))) +
    theme_publication() +
    theme(axis.text.x = element_text(angle = 90, vjust=0.5)) +
    theme( panel.grid.major.x = element_blank()) +
    theme(legend.position = "none") +
    
    geom_ribbon(aes(ymin=lower, ymax=upper), alpha=0.2, fill=mycolour) +
    
    geom_line(data=filter(worms, ftgt %in% myftgt,
                          perfstat %in% myperfstat,
                          runref %in% myruns), 
              aes(x=year, y=value, group=iter),
              size=0.5, colour="gray", inherit.aes = FALSE) +
    
    geom_line(colour=mycolour) +
    
    geom_hline(yintercept=myyintercept, linetype="dashed") +
    
    geom_vline(xintercept=periods2$year[1], linetype="dotted") +
    geom_vline(xintercept=periods2$year[2], linetype="dotted") +
    geom_vline(xintercept=periods2$year[3], linetype="dotted") +
    geom_vline(xintercept=periods2$year[4], linetype="dotted") +
    
    expand_limits(y=0) +
    labs(x="", y="value", title=myperfstat) +
    { if (myrow == "mp") {
      facet_grid(mp ~ ftgt, scales="free_y")}
    else if (myrow == "code") {
      facet_grid(code ~ ftgt, scales="free_y")
    }}  
    
  print(p)

  # ggsave(file = file.path(Res.dir,paste0(get(myrow), "_", myperfstat,"_summary_byyear.png")),
  #        device="png", width = 30, height = 20, units = "cm")
  
}


```

*Working document for Focus Group on Western Horse Mackerel 2020*

&nbsp;  

&nbsp;  

**Evaluation of rebuilding plans for Western horse mackerel**

&nbsp;  

Martin Pastoors, `r format(Sys.time(), '%d/%m/%Y')`

&nbsp;  

&nbsp;  

**Abstract**

*To be done *  


<!--1. Introduction ------------------------------------------------------ -->

# Introduction

A technical subgroup of the PELAC Focus Group on Western horse mackerel has developed and applied several evaluation tools to evaluate potential rebuilding plans for western horse mackerel. Although in the most recent assessment of western horse mackerel (WGWIDE 2019), the stock was assessed to be above Blim, there is a general perception that the stock is not doing well and that the development of a rebuilding plan would be appropriate. 

# Data and methods

The approach to evaluate potential harvest control rules (HCR) for western horse mackerel is based on two different assessments (Stock synthesis and SAM) and two different evaluation methods (EqSim and SAM HCR forecast). Both evaluation methods are of the 'short cut' type to allow for a rapid evaluation process. 


# Results


## EqSim and Stock Synthesis

### Constant F strategy

MP5.00 constant F; MP5.01 constant F with minimum TAC of 50kT; MP5.03 constant F with 20% IAV constraint above Btrigger. 

```{r echo=FALSE, fig.align="center", fig.asp=0.45, message=FALSE, warning=FALSE}

# myperfstat <- "catch"
# myperfstat <- "stock"
# myperfstat <- "fbar"
# myperfstat <- "rec"
myperfstat <- "pblim"

df %>% 
  filter(perfstat==myperfstat) %>% 
  ggplot(aes(x=year, y=mean)) +
  theme_publication() +
  theme(axis.text.x = element_text(angle = 90, vjust=0.5)) +
  theme( panel.grid.major.x = element_blank()) +
  theme(legend.position = "none") +
  
  geom_line(data=filter(wormhist, 
                        perfstat %in% myperfstat), 
            aes(x=year, y=value, group=iter),
            size=0.5, colour="gray", inherit.aes = FALSE) +
  
  geom_ribbon(data=filter(dfhist, perfstat == myperfstat), 
              aes(ymin=lower, ymax=upper), alpha=0.2, fill="blue") +
  geom_line(data=filter(dfhist, perfstat == myperfstat), colour="blue") +
  
  geom_line(data=filter(worms, 
                        perfstat %in% myperfstat), 
            aes(x=year, y=value, group=iter),
            size=0.5, colour="gray", inherit.aes = FALSE) +
  
  geom_ribbon(aes(ymin=lower, ymax=upper), alpha=0.2, fill="red") +
  geom_line(colour="red") +
  
  geom_vline(xintercept=periods2$year[1], linetype="dotted") +
  geom_vline(xintercept=periods2$year[2], linetype="dotted") +
  geom_vline(xintercept=periods2$year[3], linetype="dotted") +
  geom_vline(xintercept=periods2$year[4], linetype="dotted") +
  
  expand_limits(y=0) +
  labs(y=myperfstat) +
  facet_wrap(~ftgt)

  
  



```

### ICES advice rule

MP5.10 ICES AR; MP5.11 ICES AR with minimum TAC of 50kT; MP5.13 ICES AR with 20% IAV constraint above Btrigger. 

```{r echo=FALSE, fig.align="center", fig.asp=0.45, message=FALSE, warning=FALSE}

plotvar(myruns =  c("WHOM_SS3_OM2.2_MP5.10_1000_23", 
                    "WHOM_SS3_OM2.2_MP5.11_1000_23",
                    "WHOM_SS3_OM2.2_MP5.13_1000_23"),
        myftgt = c(0.0, 0.05, 0.075, 0.10, 0.125, 0.15),
        myperfstat = "ssb", mycolour   = "blue", myyintercept = 834000, myvalue="median")

plotvar(myruns =  c("WHOM_SS3_OM2.2_MP5.10_1000_23", 
                    "WHOM_SS3_OM2.2_MP5.11_1000_23",
                    "WHOM_SS3_OM2.2_MP5.13_1000_23"),
        myftgt = c(0.0, 0.05, 0.075, 0.10, 0.125, 0.15),
        myperfstat = "catch", mycolour   = "purple", myyintercept = as.numeric(NA), myvalue="median")

plotvar(myruns =  c("WHOM_SS3_OM2.2_MP5.10_1000_23", 
                    "WHOM_SS3_OM2.2_MP5.11_1000_23",
                    "WHOM_SS3_OM2.2_MP5.13_1000_23"),
        myftgt = c(0.0, 0.05, 0.075, 0.10, 0.125, 0.15),
        myperfstat = "pblim", mycolour   = "red", myyintercept = 0.05, myvalue="median")

```

### Double breakpoint rule

MP5.20 Double BP; MP5.11 Double BP with minimum TAC of 50kT; MP5.13 Doubl BP with 20% IAV constraint above Btrigger. Minimum F in Double BP is 20% of Fmsy. 

```{r echo=FALSE, fig.align="center", fig.asp=0.45, message=FALSE, warning=FALSE}

plotvar(myruns =  c("WHOM_SS3_OM2.2_MP5.20_1000_23", 
                    "WHOM_SS3_OM2.2_MP5.21_1000_23",
                    "WHOM_SS3_OM2.2_MP5.23_1000_23"),
        myftgt = c(0.0, 0.05, 0.075, 0.10, 0.125, 0.15),
        myperfstat = "ssb", mycolour   = "blue", myyintercept = 834000, myvalue="median")

plotvar(myruns =  c("WHOM_SS3_OM2.2_MP5.20_1000_23", 
                    "WHOM_SS3_OM2.2_MP5.21_1000_23",
                    "WHOM_SS3_OM2.2_MP5.23_1000_23"),
        myftgt = c(0.0, 0.05, 0.075, 0.10, 0.125, 0.15),
        myperfstat = "catch", mycolour   = "purple", myyintercept = as.numeric(NA), myvalue="median")

plotvar(myruns =  c("WHOM_SS3_OM2.2_MP5.20_1000_23", 
                    "WHOM_SS3_OM2.2_MP5.21_1000_23",
                    "WHOM_SS3_OM2.2_MP5.23_1000_23"),
        myftgt = c(0.0, 0.05, 0.075, 0.10, 0.125, 0.15),
        myperfstat = "pblim", mycolour   = "red", myyintercept = 0.05, myvalue="median")

```

### Probability of achieving rebuilding with 20% IAV constraint above Btrigger

```{r echo=FALSE, fig.align="center", fig.asp=0.8, message=FALSE, warning=FALSE}

myftgt = c(0.0, 0.05, 0.075, 0.10, 0.125, 0.15)
myruns =  c("WHOM_SS3_OM2.2_MP5.03_1000_23", 
            "WHOM_SS3_OM2.2_MP5.13_1000_23",
            "WHOM_SS3_OM2.2_MP5.23_1000_23")
 
r <-
  df %>% 
  filter(ftgt %in% myftgt) %>% 
  filter(perfstat %in% c("recovblim","recovbpa")) %>%
  filter(runref %in% myruns) %>% 
  filter(median >= 0.5) %>%
  group_by(runref, mp, perfstat, ftgt) %>% 
  filter(year == min(year))

mp <- r %>% ungroup() %>% distinct(mp) %>% summarize(s = paste(mp, collapse="_")) %>% as.character()

# plot recovery to blim and bpa
df %>%
  filter(ftgt %in% myftgt) %>% 
  filter(perfstat %in% c("recovblim","recovbpa")) %>% 
  filter(runref %in% myruns) %>% 
  # separate(runref, into=c("stock","assess","om","mp","iters","nyears"), sep="_", convert=FALSE) %>% 
  mutate(code = paste(method, assess,om,mp,sep="_")) %>% 
  
  ggplot(aes(x=year, y=median, group=perfstat)) +
  theme_publication() +
  theme(axis.text.x = element_text(angle = 90, vjust=0.5)) +
  theme( panel.grid.major.x = element_blank()) +
  # theme(legend.position = "none") +
  
  geom_line(aes(colour=perfstat)) +
  
  geom_vline(xintercept=periods2$year[1], linetype="dotted") +
  geom_vline(xintercept=periods2$year[2], linetype="dotted") +
  geom_vline(xintercept=periods2$year[3], linetype="dotted") +
  geom_vline(xintercept=periods2$year[4], linetype="dotted") +
  
  geom_vline(data=r, aes(xintercept=year, colour=perfstat), linetype="dashed", size=0.5) +
  
  # geom_text(data=r, aes(x=year, colour=perfstat, label=year), y = -Inf, vjust=-1.2) +
  ggrepel::geom_text_repel(data=r, aes(x=year, colour=perfstat, label=year), y=-Inf)  +
  
  expand_limits(y=0) +
  labs(x="", y="value", title="Recovery to Blim and Bpa") +
  facet_grid(mp ~ ftgt, scales="free_y")

# ggsave(file = file.path(Res.dir,paste0(mp, "_recovery_summary_byyear.png")),
#        device="png", width = 30, height = 20, units = "cm")

```

## EqSim and SAM

### Constant F rule with SAM assessment

Results for the constant F rule are not presented because it was clear that this option would not be selected by the PELAC for the potential rebuilding plan.

### ICES Advice Rule with SAM assessment

MP5.10 ICES AR; MP5.11 ICES AR with minimum TAC of 50kT; MP5.13 ICES AR with 20% IAV constraint above Btrigger. 

```{r echo=FALSE, fig.align="center", fig.asp=0.45, message=FALSE, warning=FALSE}

plotvar(myruns =  c("WHOM_SAM_OM2.3_MP5.10_1000_23", 
                    "WHOM_SAM_OM2.3_MP5.11_1000_23",
                    "WHOM_SAM_OM2.3_MP5.13_1000_23"),
        myftgt = c(0.0, 0.05, 0.075, 0.10, 0.125, 0.15),
        myperfstat = "ssb", mycolour   = "blue", myyintercept = 611814, myvalue="median")

plotvar(myruns =  c("WHOM_SAM_OM2.3_MP5.10_1000_23", 
                    "WHOM_SAM_OM2.3_MP5.11_1000_23",
                    "WHOM_SAM_OM2.3_MP5.13_1000_23"),
        myftgt = c(0.0, 0.05, 0.075, 0.10, 0.125, 0.15),
        myperfstat = "catch", mycolour   = "purple", myyintercept = as.numeric(NA), myvalue="median")

plotvar(myruns =  c("WHOM_SAM_OM2.3_MP5.10_1000_23", 
                    "WHOM_SAM_OM2.3_MP5.11_1000_23",
                    "WHOM_SAM_OM2.3_MP5.13_1000_23"),
        myftgt = c(0.0, 0.05, 0.075, 0.10, 0.125, 0.15),
        myperfstat = "pblim", mycolour   = "red", myyintercept = 0.05, myvalue="median")

```

### Double breakpoint rule with SAM assessment

SAM Assessment.

MP5.20 Double BP; MP5.11 Double BP with minimum TAC of 50kT; MP5.13 Doubl BP with 20% IAV constraint above Btrigger. Minimum F in Double BP is 20% of Fmsy. 

```{r echo=FALSE, fig.align="center", fig.asp=0.45, message=FALSE, warning=FALSE}

plotvar(myruns =  c("WHOM_SAM_OM2.3_MP5.20_1000_23", 
                    "WHOM_SAM_OM2.3_MP5.21_1000_23",
                    "WHOM_SAM_OM2.3_MP5.23_1000_23"),
        myftgt = c(0.0, 0.05, 0.075, 0.10, 0.125, 0.15),
        myperfstat = "ssb", mycolour   = "blue", myyintercept = 611814, myvalue="median")

plotvar(myruns =  c("WHOM_SAM_OM2.3_MP5.20_1000_23", 
                    "WHOM_SAM_OM2.3_MP5.21_1000_23",
                    "WHOM_SAM_OM2.3_MP5.23_1000_23"),
        myftgt = c(0.0, 0.05, 0.075, 0.10, 0.125, 0.15),
        myperfstat = "catch", mycolour   = "purple", myyintercept = as.numeric(NA), myvalue="median")

plotvar(myruns =  c("WHOM_SAM_OM2.3_MP5.20_1000_23", 
                    "WHOM_SAM_OM2.3_MP5.21_1000_23",
                    "WHOM_SAM_OM2.3_MP5.23_1000_23"),
        myftgt = c(0.0, 0.05, 0.075, 0.10, 0.125, 0.15),
        myperfstat = "pblim", mycolour   = "red", myyintercept = 0.05, myvalue="median")

```

### EqSim SAM: probability of achieving rebuilding with 20% IAV constraint above Btrigger

```{r echo=FALSE, fig.align="center", fig.asp=0.8, message=FALSE, warning=FALSE}

myftgt = c(0.0, 0.05, 0.075, 0.10, 0.125, 0.15)
myruns =  myruns =  c("WHOM_SAM_OM2.3_MP5.20_1000_23", 
                      "WHOM_SAM_OM2.3_MP5.21_1000_23",
                      "WHOM_SAM_OM2.3_MP5.23_1000_23")
 
r <-
  df %>% 
  filter(ftgt %in% myftgt) %>% 
  filter(perfstat %in% c("recovblim","recovbpa")) %>%
  filter(runref %in% myruns) %>% 
  filter(median >= 0.5) %>%
  group_by(runref, mp, perfstat, ftgt) %>% 
  filter(year == min(year))

mp <- r %>% ungroup() %>% distinct(mp) %>% summarize(s = paste(mp, collapse="_")) %>% as.character()

# plot recovery to blim and bpa
df %>%
  filter(ftgt %in% myftgt) %>% 
  filter(perfstat %in% c("recovblim","recovbpa")) %>% 
  filter(runref %in% myruns) %>% 
  # separate(runref, into=c("stock","assess","om","mp","iters","nyears"), sep="_", convert=FALSE) %>% 
  mutate(code = paste(method, assess,om,mp,sep="_")) %>% 
  
  ggplot(aes(x=year, y=median, group=perfstat)) +
  theme_publication() +
  theme(axis.text.x = element_text(angle = 90, vjust=0.5)) +
  theme( panel.grid.major.x = element_blank()) +
  # theme(legend.position = "none") +
  
  geom_line(aes(colour=perfstat)) +
  
  geom_vline(xintercept=periods2$year[1], linetype="dotted") +
  geom_vline(xintercept=periods2$year[2], linetype="dotted") +
  geom_vline(xintercept=periods2$year[3], linetype="dotted") +
  geom_vline(xintercept=periods2$year[4], linetype="dotted") +
  
  geom_vline(data=r, aes(xintercept=year, colour=perfstat), linetype="dashed", size=0.5) +
  
  # geom_text(data=r, aes(x=year, colour=perfstat, label=year), y = -Inf, vjust=-1.2) +
  ggrepel::geom_text_repel(data=r, aes(x=year, colour=perfstat, label=year), y=-Inf)  +
  
  expand_limits(y=0) +
  labs(x="", y="value", title="Recovery to Blim and Bpa") +
  facet_grid(mp ~ ftgt, scales="free_y")

# ggsave(file = file.path(Res.dir,paste0(mp, "_recovery_summary_byyear.png")),
#        device="png", width = 30, height = 20, units = "cm")

``` 

## SAM and SAM HCR forecast

SAM Assessment.

MP5.10 ICES AR.  


```{r echo=FALSE, fig.align="center", fig.asp=0.35, message=FALSE, warning=FALSE}

plotvar(myruns =  c("samhcr_WHOM_sam_-_5.10_1000_23"),
        myftgt = c(0.0, 0.05, 0.075, 0.10, 0.125, 0.15),
        myperfstat = "ssb", mycolour   = "blue", myyintercept = 611814, myvalue="median")

plotvar(myruns =  c("samhcr_WHOM_sam_-_5.10_1000_23"),
        myftgt = c(0.0, 0.05, 0.075, 0.10, 0.125, 0.15),
        myperfstat = "catch", mycolour   = "purple", myyintercept = as.numeric(NA), myvalue="median")

plotvar(myruns =  c("samhcr_WHOM_sam_-_5.10_1000_23"),
        myftgt = c(0.0, 0.05, 0.075, 0.10, 0.125, 0.15),
        myperfstat = "pblim", mycolour   = "red", myyintercept = 0.05, myvalue="median")

# df %>% filter(runref == "samhcr_WHOM_sam_-_5.10_1000_23") %>% distinct(perfstat)

```

## Comparison of SS & SAM / EqSim & SAM HCR

```{r echo=FALSE, fig.align="center", fig.asp=0.35, message=FALSE, warning=FALSE}

plotvar(myruns =  c("WHOM_SS3_OM2.2_MP5.10_1000_23"),
        myftgt = c(0.0, 0.05, 0.075, 0.10, 0.125, 0.15),
        myperfstat = "ssb", mycolour   = "blue", myyintercept = 834000, myvalue="median", myrow="code")

plotvar(myruns =  c("WHOM_SAM_OM2.3_MP5.10_1000_23"),
        myftgt = c(0.0, 0.05, 0.075, 0.10, 0.125, 0.15),
        myperfstat = "ssb", mycolour   = "blue", myyintercept = 611814, myvalue="median", myrow="code")

plotvar(myruns =  c("samhcr_WHOM_sam_-_5.10_1000_23"),
        myftgt = c(0.0, 0.05, 0.075, 0.10, 0.125, 0.15),
        myperfstat = "ssb", mycolour   = "blue", myyintercept = 611814, myvalue="median", myrow="code")

# df %>% filter(runref == "samhcr_WHOM_sam_-_5.10_1000_23") %>% filter(ftgt==0.075) %>% View()

```

```{r echo=FALSE, fig.align="center", fig.asp=0.35, message=FALSE, warning=FALSE}

plotvar(myruns =  c("WHOM_SS3_OM2.2_MP5.10_1000_23"),
        myftgt = c(0.0, 0.05, 0.075, 0.10, 0.125, 0.15),
        myperfstat = "catch", mycolour   = "purple", myyintercept = as.numeric(NA), myvalue="median",
        myrow="code")

plotvar(myruns =  c("WHOM_SAM_OM2.3_MP5.10_1000_23"),
        myftgt = c(0.0, 0.05, 0.075, 0.10, 0.125, 0.15),
        myperfstat = "catch", mycolour   = "purple", myyintercept = as.numeric(NA), myvalue="median",
        myrow="code")

plotvar(myruns =  c("samhcr_WHOM_sam_-_5.10_1000_23"),
        myftgt = c(0.0, 0.05, 0.075, 0.10, 0.125, 0.15),
        myperfstat = "catch", mycolour   = "purple", myyintercept = as.numeric(NA), myvalue="median",
        myrow="code")

# df %>% filter(runref == "samhcr_WHOM_sam_-_5.10_1000_23") %>% filter(ftgt==0.075) %>% View()

```

```{r echo=FALSE, fig.align="center", fig.asp=0.35, message=FALSE, warning=FALSE}

  plotvar(myruns =  c("WHOM_SS3_OM2.2_MP5.10_1000_23"),
        myftgt = c(0.0, 0.05, 0.075, 0.10, 0.125, 0.15),
        myperfstat = "rec", mycolour   = "orange", myyintercept = as.numeric(NA),
        myvalue="median",
        myrow="code")

  plotvar(myruns =  c("WHOM_SAM_OM2.3_MP5.10_1000_23"),
        myftgt = c(0.0, 0.05, 0.075, 0.10, 0.125, 0.15),
        myperfstat = "rec", mycolour   = "orange", myyintercept = as.numeric(NA),
        myvalue="median",
        myrow="code")

  plotvar(myruns =  c("samhcr_WHOM_sam_-_5.10_1000_23"),
        myftgt = c(0.0, 0.05, 0.075, 0.10, 0.125, 0.15),
        myperfstat = "rec", mycolour   = "orange", myyintercept = as.numeric(NA),
        myvalue="median",
        myrow="code")

# cowplot::plot_grid(p1 + theme(legend.position="none") , 
#                    p2, p3, 
#                    ncol=1, rel_heights =c(2,2,2), align="v")

# ggsave(file = file.path(Res.dir,paste0("_recruitment.png")),
#        device="png", width = 30, height = 20, units = "cm")

# df %>% filter(runref == "samhcr_WHOM_sam_-_5.10_1000_23") %>% filter(ftgt==0.075) %>% View()

```

```{r echo=FALSE, fig.align="center", fig.asp=0.35, message=FALSE, warning=FALSE}

plotvar(myruns =  c("WHOM_SS3_OM2.2_MP5.10_1000_23"),
        myftgt = c(0.0, 0.05, 0.075, 0.10, 0.125, 0.15),
        myperfstat = "pblim", mycolour   = "red", myyintercept = 0.05, myvalue="median", myrow="code")

plotvar(myruns =  c("WHOM_SAM_OM2.3_MP5.10_1000_23"),
        myftgt = c(0.0, 0.05, 0.075, 0.10, 0.125, 0.15),
        myperfstat = "pblim", mycolour   = "red", myyintercept = 0.05, myvalue="median", myrow="code")

plotvar(myruns =  c("samhcr_WHOM_sam_-_5.10_1000_23"),
        myftgt = c(0.0, 0.05, 0.075, 0.10, 0.125, 0.15),
        myperfstat = "pblim", mycolour   = "red", myyintercept = 0.05, myvalue="median", myrow="code")

# df %>% filter(runref == "samhcr_WHOM_sam_-_5.10_1000_23") %>% filter(ftgt==0.075) %>% View()

```

[ Recovery to Blim and Bpa not available for SAM HCR? ]

```{r echo=FALSE, fig.align="center", fig.asp=0.8, message=FALSE, warning=FALSE}

myftgt = c(0.0, 0.05, 0.075, 0.10, 0.125, 0.15)
myruns = c("WHOM_SS3_OM2.2_MP5.10_1000_23",
           "WHOM_SAM_OM2.3_MP5.10_1000_23",
           "samhcr_WHOM_sam_-_5.10_1000_23")
r <-
  df %>% 
  filter(ftgt %in% myftgt) %>% 
  filter(perfstat %in% c("recovblim","recovbpa")) %>%
  filter(runref %in% myruns) %>% 
  filter(median >= 0.5) %>%
  mutate(code = paste(method, assess,sep="_")) %>% 
  group_by(runref, code, mp, perfstat, ftgt) %>% 
  filter(year == min(year))

mp <- r %>% ungroup() %>% distinct(mp) %>% summarize(s = paste(mp, collapse="_")) %>% as.character()

# plot recovery to blim and bpa
df %>%
  filter(ftgt %in% myftgt) %>% 
  filter(perfstat %in% c("recovblim","recovbpa")) %>% 
  filter(runref %in% myruns) %>% 
  # separate(runref, into=c("stock","assess","om","mp","iters","nyears"), sep="_", convert=FALSE) %>% 
  mutate(code = paste(method, assess,sep="_")) %>% 
  
  ggplot(aes(x=year, y=median, group=perfstat)) +
  theme_publication() +
  theme(axis.text.x = element_text(angle = 90, vjust=0.5)) +
  theme( panel.grid.major.x = element_blank()) +
  # theme(legend.position = "none") +
  
  geom_line(aes(colour=perfstat)) +
  
  geom_vline(xintercept=periods2$year[1], linetype="dotted") +
  geom_vline(xintercept=periods2$year[2], linetype="dotted") +
  geom_vline(xintercept=periods2$year[3], linetype="dotted") +
  geom_vline(xintercept=periods2$year[4], linetype="dotted") +
  
  geom_vline(data=r, aes(xintercept=year, colour=perfstat), linetype="dashed", size=0.5) +
  
  # geom_text(data=r, aes(x=year, colour=perfstat, label=year), y = -Inf, vjust=-1.2) +
  ggrepel::geom_text_repel(data=r, aes(x=year, colour=perfstat, label=year), y=-Inf)  +
  
  expand_limits(y=0) +
  labs(x="", y="value", title="Recovery to Blim and Bpa") +
  facet_grid(code ~ ftgt, scales="free_y")

# ggsave(file = file.path(Res.dir,paste0(mp, "_recovery_summary_byyear.png")),
#        device="png", width = 30, height = 20, units = "cm")

``` 

# Discussion

Two different assessment methods (SS, SAM); two different MSE methods (EqSim, SAM HCR)

##### page break

# Preferred rebuilding plan option by PELAC

The PELAC selected the following preferred option for the Western horse mackerel rebuilding plan: 

* Evaluation method: EqSim
* Assessment: Stock Synthesis (WGWIDE 2019)
* Target fishing mortality at Fmsy = 0.074 (approximated by 0.075 in the simulations)
* Blim at ICES Blim (834 480 t)
* Btrigger at MSY Btrigger (1 168 272 t)
* Double breakpoint rule with 20% constraint on IAV above Btrigger
* Minimum F when stock is below Blim at 20% of Fmsy = 0.015
* 50% probability of rebuilding to Blim by 2021 (simular to zero catch option)
* 50% probability of rebuilding to Bpa by 2024 (similar to zero catch option)

```{r echo=FALSE, fig.align="center", fig.asp=1.2, message=FALSE, warning=FALSE}

myftgt = c(0.075)
myruns =  c("WHOM_SS3_OM2.2_MP5.23_1000_23")
myperfstat = c("catch","ssb","harvest", "rec", 'iav', "pblim", "recovblim","recovbpa")

r <-
  df %>% 
  filter(ftgt %in% myftgt) %>% 
  filter(perfstat %in% c("recovblim","recovbpa")) %>%
  filter(runref %in% myruns) %>% 
  filter(median >= 0.5) %>%
  group_by(runref, mp, perfstat, ftgt) %>% 
  filter(year == min(year)) %>% 
  ungroup() %>% 
  mutate(perfstat = factor(perfstat, levels=myperfstat))


w <- 
  worms %>% 
  filter(ftgt %in% myftgt,
         runref %in% myruns, 
         perfstat %in% myperfstat) %>% 
  mutate(perfstat = factor(perfstat, levels=myperfstat)) 

df %>%
  filter(ftgt %in% myftgt) %>% 
  filter(runref %in% myruns) %>% 
  filter(perfstat %in% myperfstat) %>% 
  mutate(perfstat = factor(perfstat, levels=myperfstat)) %>% 
  mutate(code = paste(method, assess,om,mp,sep="_")) %>% 
  
  mutate(intercept = ifelse(perfstat == "ssb", blim, as.numeric(NA))) %>% 
  mutate(intercept = ifelse(perfstat == "harvest", 0.074, intercept)) %>% 
  mutate(intercept = ifelse(perfstat == "pblim", 0.05, intercept)) %>% 
  
  mutate(intercept2 = ifelse(perfstat == "ssb", blim, as.numeric(NA))) %>% 
  
  ggplot(aes(x=year, y=median)) +
  theme_publication() +
  theme(axis.text.x = element_text(angle = 90, vjust=0.5)) +
  theme( panel.grid.major.x = element_blank()) +
  theme(legend.position = "none") +
  geom_ribbon(aes(ymin=lower, ymax=upper, fill=perfstat), alpha=0.2) +
    
  geom_line(data=w,
            aes(x=year, y=value, group=iter),
            size=0.5, colour="gray", inherit.aes = FALSE) +
    
  geom_line(aes(colour=perfstat)) +
  
  geom_vline(xintercept=periods2$year[1], linetype="dotted") +
  geom_vline(xintercept=periods2$year[2], linetype="dotted") +
  geom_vline(xintercept=periods2$year[3], linetype="dotted") +
  geom_vline(xintercept=periods2$year[4], linetype="dotted") +
  
  geom_hline(aes(yintercept=intercept), colour="black", linetype="dashed", size=0.5) +
  
  geom_vline(data=r, aes(xintercept=year, colour=perfstat), linetype="dashed", size=0.5) +
  ggrepel::geom_text_repel(data=r, aes(x=year, colour=perfstat, label=year), y=-Inf)  +
  
  expand_limits(y=0) +
  labs(x="", y="value", title="Summary of preferred rebuilding plan scenario") +
  facet_wrap( ~ perfstat, scales="free_y")

# ggsave(file = file.path(Res.dir,paste0(mp, "_recovery_summary_byyear.png")),
#        device="png", width = 30, height = 20, units = "cm")

```
##### page break

Table of results

```{r echo=FALSE, fig.align="center", fig.asp=1.2, message=FALSE, warning=FALSE}

myftgt = c(0.075)
myruns =  c("WHOM_SS3_OM2.2_MP5.23_1000_23")
myperfstat = c("catch","ssb","harvest", "rec", 'iav', "pblim")
myfile = filelist[19]

OM <- loadRData(myfile)[["OM"]]
MP <- loadRData(myfile)[["MP"]]
x <-
  loadRData(myfile)[["df"]] %>%
  lowcase() %>%
  mutate(perfstat = tolower(perfstat)) %>%
  mutate(perfstat = ifelse(perfstat == "cw", "catch", perfstat)) %>%
  mutate(method = "EqSim") %>%
  mutate(iter   = as.numeric(iter)) %>%
  mutate(niters = as.numeric(niters)) %>%
  mutate(nyrs   = as.numeric(nyrs)) %>%
  mutate(blim = OM[["refPts"]][["Blim"]]) %>%
  mutate(bpa = OM[["refPts"]][["Bpa"]]) %>% 
  
  filter(ftgt %in% myftgt) %>% 
  filter(runref %in% myruns) %>% 
  filter(perfstat %in% myperfstat) 

# summarize the dataframe for this run
summ <-
  x %>%
  group_by(runref, assess, method, om, mp, niters, nyrs, label, ftgt, perfstat, unit, blim, bpa,
           period) %>%
  mutate(value = ifelse(perfstat=="iav" & ftgt==0, NA, value)) %>%
  summarize(median = median(value, na.rm=TRUE),
            upper = quantile(value, probs=0.975, na.rm=TRUE),
            lower = quantile(value, probs=0.025, na.rm=TRUE)) %>%
  ungroup() %>% 
  mutate(median = ifelse(perfstat %in% c("catch","ssb","rec"), 
                         paste0(scales::comma(median, accuracy=1)),
                         paste0(scales::number(median, accuracy=0.001)))
         ) %>% 
  mutate(range = ifelse(perfstat %in% c("catch","ssb","rec"), 
                         paste0(scales::comma(lower, accuracy=1)," - ",
                                scales::comma(upper, accuracy=1) ),
                         paste0(scales::number(lower, accuracy=0.001)," - ",
                                scales::number(upper, accuracy=0.001)))
         ) %>% 
  left_join(dplyr::select(periods2, period, yearrange), by="period") %>% 
  mutate(perfstat = factor(perfstat, levels=myperfstat)) %>% 
  mutate(period   = factor(period, levels=c("CU","ST","MT","LT")))

summ %>% 
    dplyr::select(one_of("perfstat","yearrange", "period", "median","range")) %>%
    arrange(yearrange) %>% 
    group_by(perfstat) %>% 
    do(add_row(., .after=0)) %>%    
    pander::pandoc.table(., 
                 style        = "simple",
                 split.tables = 100, 
                 split.cells  = c(rep(7,10)),
                 justify      = "left",
                 missing      =" ",
                 big.mark     = ',', 
                 round        = c(0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0))

```

Table of settings

```{r echo=FALSE, fig.align="center", fig.asp=1.2, message=FALSE, warning=FALSE}

myftgt = c(0.075)
myruns =  c("WHOM_SS3_OM2.2_MP5.23_1000_23")

s <-
  loadRData(file.path(Res.dir,"stats",paste0(myruns,"_eqSim_Stats.Rdata")))

names(s)

s[["settings"]] %>% 
  pander::pandoc.table(., 
                 style        = "simple",
                 split.tables = 100, 
                 split.cells  = c(rep(7,10)),
                 justify      = "left",
                 missing      =" ",
                 big.mark     = ',', 
                 round        = c(0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0))

```

##### page break


